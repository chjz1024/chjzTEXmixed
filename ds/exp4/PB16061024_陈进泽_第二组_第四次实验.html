<!DOCTYPE html>
    <html>
    <head>
        <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
        <title>键盘阵列扫描输出实验报告 PB16061024 陈进泽</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
        <link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <style>
.task-list-item { list-style-type: none; } .task-list-item-checkbox { margin-left: -20px; vertical-align: middle; }
</style>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
body{font-family: "宋体"; font-size: 16px;} h1, h2, h3, h4, h5, h6{ font-weight: bold} img + br + em { font-style: normal; display: inherit; text-align: center; font-size: 90%; }
</style>
        <script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
    </head>
    <body>
        <h1 id="%E9%94%AE%E7%9B%98%E9%98%B5%E5%88%97%E6%89%AB%E6%8F%8F%E8%BE%93%E5%87%BA%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A-pb16061024-%E9%99%88%E8%BF%9B%E6%B3%BD">键盘阵列扫描输出实验报告 PB16061024 陈进泽</h1>
<h1 id="%E5%AE%9E%E9%AA%8C%E5%86%85%E5%AE%B9">实验内容</h1>
<ol>
<li>进一步学习并掌握Quartus II设计的方法及步骤</li>
<li>熟悉VHDL语言电路设计方法</li>
<li>熟悉VHDL test bench(测试平台/测试激励)的设计</li>
<li>学习并掌握利用VHDL描述并设计电路的方法及步骤</li>
<li>学习并掌握健盘阵列的扫描输入的方法及实验过程</li>
</ol>
<h1 id="%E8%AE%BE%E8%AE%A1%E5%88%86%E6%9E%90">设计分析</h1>
<p>键盘扫描的原理是随时钟信号产生对应的行(列)扫描信号，再根据此时读取道德列(行)信息判断哪个键被按下，故可分为扫描信号发生器SCAN_GEN和列(行)信号读取器件READ_SCAN两个模块设计。</p>
<p>扫描信号发生器SCAN_GEN根据clk信号按序输出对应的行(列)扫描信号。</p>
<p>列(行)信号读取器READ_SCAN根据行(列)的扫描信号以及列(行)读取的信号状态输出按键译码结果。由于译码时需要知道扫描信号，为了简便起见我把行(列)扫描信号与列(行)状态信息串联为一个长度为8的信号矢量，而整个元件简化为了一个8-4译码器。</p>
<p>为了在实验板上展现结果本实验复用了第三次实验的七段数码管译码电路LED_TRANS和分频器DIV2，并将所有的器件集合在了KEYBOARD_SCAN中。</p>
<h1 id="%E6%BA%90%E4%BB%A3%E7%A0%81">源代码</h1>
<h2 id="%E6%89%AB%E6%8F%8F%E4%BF%A1%E5%8F%B7%E5%8F%91%E7%94%9F%E5%99%A8">扫描信号发生器</h2>
<pre><code class="language-vhdl"><div><span class="hljs-keyword">library</span> ieee;
<span class="hljs-keyword">use</span> ieee.std_logic_1164.<span class="hljs-keyword">all</span>;

<span class="hljs-keyword">entity</span> SCAN_GEN <span class="hljs-keyword">is</span>
  <span class="hljs-keyword">port</span> (
    clk: <span class="hljs-keyword">in</span> <span class="hljs-built_in">std_logic</span>;
    scan: <span class="hljs-keyword">buffer</span> <span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">3</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>)
  );
<span class="hljs-keyword">end</span> <span class="hljs-keyword">entity</span> SCAN_GEN;

<span class="hljs-keyword">architecture</span> rtl <span class="hljs-keyword">of</span> SCAN_GEN <span class="hljs-keyword">is</span>
<span class="hljs-keyword">begin</span>
  <span class="hljs-keyword">process</span>(clk)
    <span class="hljs-keyword">variable</span> i: <span class="hljs-built_in">integer</span> <span class="hljs-keyword">range</span> <span class="hljs-number">0</span> <span class="hljs-keyword">to</span> <span class="hljs-number">3</span> := <span class="hljs-number">0</span>;
    <span class="hljs-keyword">begin</span>
      <span class="hljs-keyword">if</span>(clk<span class="hljs-symbol">'event</span> <span class="hljs-keyword">and</span> clk=<span class="hljs-string">'1'</span>) <span class="hljs-keyword">then</span>
        scan(<span class="hljs-number">2</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>) &lt;= scan(<span class="hljs-number">3</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">1</span>);
        <span class="hljs-keyword">if</span>(i = <span class="hljs-number">3</span>) <span class="hljs-keyword">then</span>
          i := <span class="hljs-number">0</span>;
          scan(<span class="hljs-number">3</span>) &lt;= <span class="hljs-string">'0'</span>;
        <span class="hljs-keyword">else</span>
          i := i+<span class="hljs-number">1</span>;
          scan(<span class="hljs-number">3</span>) &lt;= <span class="hljs-string">'1'</span>;
        <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;
      <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;
  <span class="hljs-keyword">end</span> <span class="hljs-keyword">process</span>;
<span class="hljs-keyword">end</span> <span class="hljs-keyword">architecture</span> rtl;
</div></code></pre>
<p>本电路复用了实验三8路使能信号输出电路的代码，采用移位寄存器来实现扫描信号的输出，使用逻辑单元数小于采用计数器的实现方式。电路见下图：</p>
<p><img src="file:///c:\Users\18245\Desktop\chjzTEXmixed\ds\exp4\pic\scan_gen.png" alt="scan_gen"></p>
<h2 id="%E5%88%97%E8%A1%8C%E4%BF%A1%E5%8F%B7%E8%AF%BB%E5%8F%96">列(行)信号读取</h2>
<pre><code class="language-vhdl"><div><span class="hljs-keyword">library</span> ieee;
<span class="hljs-keyword">use</span> ieee.std_logic_1164.<span class="hljs-keyword">all</span>;

<span class="hljs-keyword">entity</span> READ_SCAN <span class="hljs-keyword">is</span>
  <span class="hljs-keyword">port</span> (
    clk: <span class="hljs-keyword">in</span> <span class="hljs-built_in">std_logic</span>;
    scan: <span class="hljs-keyword">in</span> <span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">7</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);
    result: <span class="hljs-keyword">out</span> <span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">3</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>)
  );
<span class="hljs-keyword">end</span> <span class="hljs-keyword">entity</span> READ_SCAN;

<span class="hljs-keyword">architecture</span> rtl <span class="hljs-keyword">of</span> READ_SCAN <span class="hljs-keyword">is</span>
<span class="hljs-keyword">begin</span>
  <span class="hljs-keyword">process</span>(clk,scan)
  <span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">if</span>(clk<span class="hljs-symbol">'event</span> <span class="hljs-keyword">and</span> clk=<span class="hljs-string">'1'</span>) <span class="hljs-keyword">then</span>
      <span class="hljs-keyword">case</span> scan <span class="hljs-keyword">is</span>
        <span class="hljs-keyword">when</span> <span class="hljs-string">"11101110"</span> =&gt; result &lt;= <span class="hljs-string">"1101"</span>;
        <span class="hljs-keyword">when</span> <span class="hljs-string">"11101101"</span> =&gt; result &lt;= <span class="hljs-string">"1111"</span>;
        <span class="hljs-keyword">when</span> <span class="hljs-string">"11101011"</span> =&gt; result &lt;= <span class="hljs-string">"0000"</span>;
        <span class="hljs-keyword">when</span> <span class="hljs-string">"11100111"</span> =&gt; result &lt;= <span class="hljs-string">"1110"</span>;
        <span class="hljs-keyword">when</span> <span class="hljs-string">"11011110"</span> =&gt; result &lt;= <span class="hljs-string">"1100"</span>;
        <span class="hljs-keyword">when</span> <span class="hljs-string">"11011101"</span> =&gt; result &lt;= <span class="hljs-string">"1001"</span>;
        <span class="hljs-keyword">when</span> <span class="hljs-string">"11011011"</span> =&gt; result &lt;= <span class="hljs-string">"1000"</span>;
        <span class="hljs-keyword">when</span> <span class="hljs-string">"11010111"</span> =&gt; result &lt;= <span class="hljs-string">"0111"</span>;
        <span class="hljs-keyword">when</span> <span class="hljs-string">"10111110"</span> =&gt; result &lt;= <span class="hljs-string">"1011"</span>;
        <span class="hljs-keyword">when</span> <span class="hljs-string">"10111101"</span> =&gt; result &lt;= <span class="hljs-string">"0110"</span>;
        <span class="hljs-keyword">when</span> <span class="hljs-string">"10111011"</span> =&gt; result &lt;= <span class="hljs-string">"0101"</span>;
        <span class="hljs-keyword">when</span> <span class="hljs-string">"10110111"</span> =&gt; result &lt;= <span class="hljs-string">"0100"</span>;
        <span class="hljs-keyword">when</span> <span class="hljs-string">"01111110"</span> =&gt; result &lt;= <span class="hljs-string">"1010"</span>;
        <span class="hljs-keyword">when</span> <span class="hljs-string">"01111101"</span> =&gt; result &lt;= <span class="hljs-string">"0011"</span>;
        <span class="hljs-keyword">when</span> <span class="hljs-string">"01111011"</span> =&gt; result &lt;= <span class="hljs-string">"0010"</span>;
        <span class="hljs-keyword">when</span> <span class="hljs-string">"01110111"</span> =&gt; result &lt;= <span class="hljs-string">"0001"</span>;
        <span class="hljs-keyword">when</span> <span class="hljs-keyword">others</span> =&gt; <span class="hljs-keyword">null</span>;
      <span class="hljs-keyword">end</span> <span class="hljs-keyword">case</span>;
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;
  <span class="hljs-keyword">end</span> <span class="hljs-keyword">process</span>;
<span class="hljs-keyword">end</span> <span class="hljs-keyword">architecture</span> rtl;
</div></code></pre>
<p>本电路通过在逻辑上分离了扫描信号和状态信号使得电路整体的逻辑简化为了一个8-4译码器。clk信号的使用是为了预防按键抖动。电路见下图：</p>
<p><img src="file:///c:\Users\18245\Desktop\chjzTEXmixed\ds\exp4\pic\read_scan.png" alt="read_scan"></p>
<h2 id="%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84">整体结构</h2>
<pre><code class="language-vhdl"><div><span class="hljs-keyword">library</span> ieee;
<span class="hljs-keyword">use</span> ieee.std_logic_1164.<span class="hljs-keyword">all</span>;

<span class="hljs-keyword">entity</span> KEYBOARD_SCAN <span class="hljs-keyword">is</span>
  <span class="hljs-keyword">port</span> (
    clk: <span class="hljs-keyword">in</span> <span class="hljs-built_in">std_logic</span>;
    enaout: <span class="hljs-keyword">out</span> <span class="hljs-built_in">std_logic</span>;
    enain: <span class="hljs-keyword">in</span> <span class="hljs-built_in">std_logic</span>;
    scangen: <span class="hljs-keyword">buffer</span> <span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">3</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);
    scan: <span class="hljs-keyword">in</span> <span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">3</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);
    ledout: <span class="hljs-keyword">out</span> <span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">6</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>)
  );
<span class="hljs-keyword">end</span> <span class="hljs-keyword">entity</span> KEYBOARD_SCAN;

<span class="hljs-keyword">architecture</span> rtl <span class="hljs-keyword">of</span> KEYBOARD_SCAN <span class="hljs-keyword">is</span>
  <span class="hljs-keyword">component</span> LED_TRANS <span class="hljs-keyword">is</span>
    <span class="hljs-keyword">port</span> (
      busin: <span class="hljs-keyword">in</span> <span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">3</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);
      ledout: <span class="hljs-keyword">out</span> <span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">6</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>)
    );
  <span class="hljs-keyword">end</span> <span class="hljs-keyword">component</span>;

  <span class="hljs-keyword">component</span> READ_SCAN <span class="hljs-keyword">is</span>
    <span class="hljs-keyword">port</span> (
	   clk: <span class="hljs-keyword">in</span> <span class="hljs-built_in">std_logic</span>;
      scan: <span class="hljs-keyword">in</span> <span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">7</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);
      result: <span class="hljs-keyword">out</span> <span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">3</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>)
    );
  <span class="hljs-keyword">end</span> <span class="hljs-keyword">component</span>;

  <span class="hljs-keyword">component</span> SCAN_GEN <span class="hljs-keyword">is</span>
    <span class="hljs-keyword">port</span> (
      clk: <span class="hljs-keyword">in</span> <span class="hljs-built_in">std_logic</span>;
      scan: <span class="hljs-keyword">buffer</span> <span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">3</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>)
    );
  <span class="hljs-keyword">end</span> <span class="hljs-keyword">component</span>;
  
<span class="hljs-keyword">component</span> div2 <span class="hljs-keyword">is</span>
  <span class="hljs-keyword">port</span>(
    clk: <span class="hljs-keyword">in</span> <span class="hljs-built_in">std_logic</span>;
    clkdiv: <span class="hljs-keyword">out</span> <span class="hljs-built_in">std_logic</span>
  );
<span class="hljs-keyword">end</span> <span class="hljs-keyword">component</span>;  
  <span class="hljs-keyword">signal</span> result: <span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">3</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);
  <span class="hljs-keyword">signal</span> scann: <span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">7</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);
  <span class="hljs-keyword">signal</span> clkdiv: <span class="hljs-built_in">std_logic</span>;
<span class="hljs-keyword">begin</span>
  scann &lt;= scangen &amp; scan;
  clkk: div2 <span class="hljs-keyword">port</span> <span class="hljs-keyword">map</span>(clk, clkdiv);
  gen: SCAN_GEN <span class="hljs-keyword">port</span> <span class="hljs-keyword">map</span>(clkdiv, scangen);
  scancomp: READ_SCAN <span class="hljs-keyword">port</span> <span class="hljs-keyword">map</span>(clkdiv, scann, result);
  led: LED_TRANS <span class="hljs-keyword">port</span> <span class="hljs-keyword">map</span>(result, ledout);
  enaout &lt;= enain;
  
<span class="hljs-keyword">end</span> <span class="hljs-keyword">architecture</span> rtl;
</div></code></pre>
<p>本电路在内部将扫描信号与读取状态连接在一起输入到READ_SCAN处，将clk分频以及把输出接到数码管译码器上，实现了所有结构的互联。enain与enaout目的为将拨码开关与数码管阳极直接相连。电路见下图：</p>
<p><img src="file:///c:\Users\18245\Desktop\chjzTEXmixed\ds\exp4\pic\keyboard_scan.png" alt="keyboard_scan"></p>
<h2 id="flow-summary">Flow Summary</h2>
<p><img src="file:///c:\Users\18245\Desktop\chjzTEXmixed\ds\exp4\pic\flow.png" alt="flow"></p>
<h1 id="%E4%BB%BF%E7%9C%9F%E7%BB%93%E6%9E%9C">仿真结果</h1>
<p>由于此电路较简单，本实验只提供了整体结构的仿真，其中clk并未接分频器。</p>
<pre><code class="language-vhdl"><div><span class="hljs-keyword">library</span> ieee;
<span class="hljs-keyword">use</span> ieee.std_logic_1164.<span class="hljs-keyword">all</span>;

<span class="hljs-keyword">entity</span> KEYBOARD_tb <span class="hljs-keyword">is</span>
<span class="hljs-keyword">end</span> <span class="hljs-keyword">entity</span> KEYBOARD_tb;

<span class="hljs-keyword">architecture</span> rtl <span class="hljs-keyword">of</span> KEYBOARD_tb <span class="hljs-keyword">is</span>
  <span class="hljs-keyword">component</span> KEYBOARD_SCAN <span class="hljs-keyword">is</span>
    <span class="hljs-keyword">port</span> (
      clk: <span class="hljs-keyword">in</span> <span class="hljs-built_in">std_logic</span>;
      enaout: <span class="hljs-keyword">out</span> <span class="hljs-built_in">std_logic</span>;
      enain: <span class="hljs-keyword">in</span> <span class="hljs-built_in">std_logic</span>;
      scangen: <span class="hljs-keyword">buffer</span> <span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">3</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);
      scan: <span class="hljs-keyword">in</span> <span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">3</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);
      ledout: <span class="hljs-keyword">out</span> <span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">6</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>)
    );
  <span class="hljs-keyword">end</span> <span class="hljs-keyword">component</span>;

  <span class="hljs-keyword">signal</span> clk:  <span class="hljs-built_in">std_logic</span>;
  <span class="hljs-keyword">signal</span> enaout:  <span class="hljs-built_in">std_logic</span>;
  <span class="hljs-keyword">signal</span> enain:  <span class="hljs-built_in">std_logic</span>;
  <span class="hljs-keyword">signal</span> scangen:  <span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">3</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);
  <span class="hljs-keyword">signal</span> scan:  <span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">3</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);
  <span class="hljs-keyword">signal</span> ledout:  <span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">6</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);
<span class="hljs-keyword">begin</span>
  key: KEYBOARD_SCAN <span class="hljs-keyword">port</span> <span class="hljs-keyword">map</span>(clk,enaout,enain,scangen,scan,ledout);

  clock: <span class="hljs-keyword">process</span>
  <span class="hljs-keyword">begin</span>
    clk &lt;= <span class="hljs-string">'0'</span>;
    <span class="hljs-keyword">wait</span> <span class="hljs-keyword">for</span> <span class="hljs-number">10</span> ns;
    clk &lt;= <span class="hljs-string">'1'</span>;
    <span class="hljs-keyword">wait</span> <span class="hljs-keyword">for</span> <span class="hljs-number">10</span> ns;
  <span class="hljs-keyword">end</span> <span class="hljs-keyword">process</span> clock;

  keyboard: <span class="hljs-keyword">process</span>(scangen)
  <span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">case</span> scangen <span class="hljs-keyword">is</span>
      <span class="hljs-keyword">when</span> <span class="hljs-string">"1101"</span> =&gt; scan &lt;= <span class="hljs-string">"0111"</span>;
      <span class="hljs-keyword">when</span> <span class="hljs-keyword">others</span> =&gt; scan &lt;= <span class="hljs-string">"1111"</span>;
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">case</span>;
  <span class="hljs-keyword">end</span> <span class="hljs-keyword">process</span> keyboard;
<span class="hljs-keyword">end</span> <span class="hljs-keyword">architecture</span> rtl;
</div></code></pre>
<p>本仿真目的就是模仿当仅有一个键按下时整个电路的变化情况。仿真结果如下：</p>
<p><img src="file:///c:\Users\18245\Desktop\chjzTEXmixed\ds\exp4\pic\sim.png" alt="sim"></p>
<p>当按键7被按下时LED显示为7，与预期一致</p>
<h1 id="fpga%E9%AA%8C%E8%AF%81%E7%BB%93%E6%9E%9C">FPGA验证结果</h1>
<h2 id="%E5%BC%95%E8%84%9A%E5%88%86%E9%85%8D">引脚分配</h2>
<p><img src="file:///c:\Users\18245\Desktop\chjzTEXmixed\ds\exp4\pic\pin.png" alt="pin"></p>
<h2 id="%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C">实验结果</h2>
<p>按下某一键后数码管会显示对应数字，且即使快速按某一键也不会出现显示数组抖动情况。</p>
<h1 id="%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93">实验总结</h1>
<p>本次实验较简单，但因为一些小的问题(没有全编译就烧写程序)从而出现了找不出错误的情况。关于这点一方面以后操作的时候应该更细心，另一方面Quartus软件在编译完成前就有输出文件很有迷惑性，如果能有对应提示无疑会更好。</p>

    </body>
    </html>